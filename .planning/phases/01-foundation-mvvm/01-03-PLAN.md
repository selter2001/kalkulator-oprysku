---
phase: 01-foundation-mvvm
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - SprayCalculator/ContentView.swift
  - SprayCalculator/LocalizationManager.swift
autonomous: true

must_haves:
  truths:
    - "Po obliczeniu uzytkownik widzi sklad pelnego zbiornika: ile litrow wody + ile litrow srodka"
    - "Po obliczeniu uzytkownik widzi sklad niepelnego zbiornika: ile litrow wody + ile litrow srodka"
    - "Po obliczeniu uzytkownik widzi sumaryczna ilosc srodka do kupienia na cale pole"
    - "Cala logika obliczen i walidacji jest w CalcViewModel -- widok tylko wyswietla i binduje"
    - "Historia, ulubione, animacja traktora, walidacja z haptic feedback dzialaja jak wczesniej"
  artifacts:
    - path: "SprayCalculator/ContentView.swift"
      provides: "CalculatorViewWithFavorite refaktorowany na @Bindable CalcViewModel + 3 nowe ResultCards"
    - path: "SprayCalculator/LocalizationManager.swift"
      provides: "Nowe klucze: fullTankComposition, partialTankComposition, water, totalChemicalToBuy"
  key_links:
    - from: "ContentView.swift (CalculatorViewWithFavorite)"
      to: "CalcViewModel"
      via: "@Bindable binding for TextFields"
      pattern: "@Bindable"
    - from: "ContentView.swift resultsSection"
      to: "SprayCalculation.waterPerFullTank/waterForPartialTank"
      via: "result.waterPerFullTank in ResultCard"
      pattern: "waterPerFullTank|waterForPartialTank"
---

<objective>
Zintegrowac CalcViewModel z CalculatorViewWithFavorite (cienki widok z bindingami), dodac 3 nowe ResultCards (sklad pelnego zbiornika, sklad niepelnego, srodek do kupienia), dodac klucze lokalizacji, podlaczyc animacje i ulubione.

Purpose: Dostarcza CALC-01, CALC-02, CALC-03 (per-tank composition) i UI-04 (MVVM widok). Uzytkownik po raz pierwszy zobaczy dokladny sklad kazdego zbiornika.
Output: Przebudowany CalculatorViewWithFavorite z CalcViewModel, nowe ResultCards w wynikach.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-mvvm/01-RESEARCH.md
@.planning/phases/01-foundation-mvvm/01-01-SUMMARY.md
@.planning/phases/01-foundation-mvvm/01-02-SUMMARY.md

Kluczowe pliki do przeczytania przed rozpoczeciem:
- SprayCalculator/ContentView.swift (widok do refaktoryzacji -- CalculatorViewWithFavorite)
- SprayCalculator/ViewModels/CalcViewModel.swift (VM stworzony w planie 01-02)
- SprayCalculator/LocalizationManager.swift (dodac nowe klucze)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Przebudowac CalculatorViewWithFavorite na CalcViewModel z @Bindable</name>
  <files>
    SprayCalculator/ContentView.swift
  </files>
  <action>
**1. Przebudowac CalculatorViewWithFavorite w ContentView.swift:**

Usunac CALA logike obliczen z CalculatorViewWithFavorite. Widok staje sie cienki:

- Usunac @State pola: fieldArea, sprayRate, chemicalRate, tankCapacity, selectedAreaUnit, calculationResult, showResults, showAnimation, shakingFields, showError, errorMessage
- Zachowac @State: showSaveDialog, favoriteName (czysto UI)
- Dodac: `@Bindable var viewModel: CalcViewModel` jako parametr widoku
- Uzyc $viewModel.fieldAreaText, $viewModel.sprayRateText itd. w SprayInputField
- Zamienic performCalculation() na viewModel.calculate(invalidValueError: localization.invalidValueError)
- Zamienic clearFields() na viewModel.clear()
- Zamienic loadFavorite() na viewModel.loadFavorite()
- Zamienic formatNumber() na viewModel.formatNumber()
- Zamienic tankFillsDescription() na viewModel.tankFillsDescription()

Nowa sygnatura CalculatorViewWithFavorite:
```swift
struct CalculatorViewWithFavorite: View {
    @Bindable var viewModel: CalcViewModel
    @Environment(LocalizationManager.self) private var localization
    @Environment(FavoritesManager.self) private var favoritesManager
    @Binding var selectedFavorite: FavoriteConfiguration?
    @State private var showSaveDialog = false
    @State private var favoriteName: String = ""
    // ...
}
```

**2. Stworzyc CalcViewModel w ContentView i przekazac do CalculatorViewWithFavorite:**

Problem inicjalizacji @State + @Environment: @Environment nie jest dostepne w init().

**UZYJ TEGO PODEJSCIA:** Lazy initialization pattern z task/onAppear w ContentView. CalcViewModel tworzony raz i trzymany w @State.

```swift
struct ContentView: View {
    @Environment(HistoryManager.self) private var historyManager
    // ...
    @State private var viewModel: CalcViewModel?

    var body: some View {
        Group {
            if let viewModel {
                mainContent(viewModel: viewModel)
            } else {
                Color.clear // Placeholder, natychmiast zastapiony
            }
        }
        .task {
            if viewModel == nil {
                viewModel = CalcViewModel(historyManager: historyManager)
            }
        }
    }

    private func mainContent(viewModel: CalcViewModel) -> some View {
        TabView(selection: $selectedTab) { /* ... */ }
    }
}
```

**3. Zaktualizowac animacje traktora:**

Animacja traktora musi wywolac `viewModel.onAnimationComplete()`:
```swift
.overlay {
    if viewModel.showAnimation {
        TractorSprayingAnimation {
            withAnimation(.spring(response: 0.5, dampingFraction: 0.8)) {
                viewModel.onAnimationComplete()
            }
        }
        .transition(.opacity)
    }
}
```

**4. Zaktualizowac saveFavorite:**

```swift
private func saveFavorite() {
    let favorite = FavoriteConfiguration(
        name: favoriteName,
        sprayRate: viewModel.parseNumber(viewModel.sprayRateText) ?? 0,
        chemicalRate: viewModel.parseNumber(viewModel.chemicalRateText) ?? 0,
        tankCapacity: viewModel.parseNumber(viewModel.tankCapacityText) ?? 0,
        areaUnit: viewModel.selectedAreaUnit
    )
    favoritesManager.addFavorite(favorite)
    showSaveDialog = false
    favoriteName = ""
}
```

**5. Zaktualizowac onChange selectedFavorite:**

```swift
.onChange(of: selectedFavorite) {
    if let favorite = selectedFavorite {
        viewModel.loadFavorite(favorite)
        selectedFavorite = nil
    }
}
```
  </action>
  <verify>
grep "performCalculation\|func calculate\b" SprayCalculator/ContentView.swift | wc -l  # 0 (logika przeniesiona do VM)
grep "@Bindable" SprayCalculator/ContentView.swift  # Znalezione
grep "viewModel.calculate" SprayCalculator/ContentView.swift  # Znalezione
grep "viewModel.onAnimationComplete" SprayCalculator/ContentView.swift  # Znalezione
grep "viewModel.loadFavorite" SprayCalculator/ContentView.swift  # Znalezione
  </verify>
  <done>CalculatorViewWithFavorite jest cienkim widokiem z @Bindable CalcViewModel. Logika obliczen, walidacji, formatowania jest w CalcViewModel. Animacja, ulubione i onChange poprawnie podlaczone do VM.</done>
</task>

<task type="auto">
  <name>Task 2: Dodac 3 nowe ResultCards (per-tank composition) i klucze lokalizacji</name>
  <files>
    SprayCalculator/ContentView.swift
    SprayCalculator/LocalizationManager.swift
  </files>
  <action>
**1. Dodac brakujace klucze lokalizacji do LocalizationManager.swift:**

Dodac w `LocalizationManager.swift`:
```swift
var fullTankComposition: String {
    currentLanguage == .polish ? "SkÅ‚ad peÅ‚nego zbiornika" : "Full tank composition"
}

var partialTankComposition: String {
    currentLanguage == .polish ? "SkÅ‚ad niepeÅ‚nego zbiornika" : "Partial tank composition"
}

var water: String {
    currentLanguage == .polish ? "Woda" : "Water"
}

var totalChemicalToBuy: String {
    currentLanguage == .polish ? "Åšrodek do kupienia" : "Chemical to buy"
}
```

**2. Rozszerzyc resultsSection o per-tank composition w ContentView.swift:**

W CalculatorViewWithFavorite.resultsSection() dodac NOWE ResultCard po istniejacych:

```swift
// ISTNIEJACE: Ciecz robocza, Srodek, Napelnienia...

// NOWE: Sklad pelnego zbiornika (CALC-01)
ResultCard(
    icon: "ðŸª£",
    title: localization.fullTankComposition,
    value: "\(viewModel.formatNumber(result.waterPerFullTank)) l + \(viewModel.formatNumber(result.chemicalPerTank)) l",
    unit: "",
    detail: "\(localization.water) + \(localization.chemical)",
    delay: 0.4
)

// NOWE: Sklad niepelnego zbiornika (CALC-02)
if result.hasPartialTank {
    ResultCard(
        icon: "ðŸ«—",
        title: localization.partialTankComposition,
        value: "\(viewModel.formatNumber(result.waterForPartialTank)) l + \(viewModel.formatNumber(result.chemicalForPartialTank)) l",
        unit: "",
        detail: "\(localization.water) + \(localization.chemical)",
        delay: 0.5
    )
}

// NOWE: Srodek do kupienia (CALC-03)
ResultCard(
    icon: "ðŸ›’",
    title: localization.totalChemicalToBuy,
    value: viewModel.formatNumber(result.totalChemical),
    unit: localization.liters,
    delay: 0.6
)
```

Upewnic sie ze delay nowych kart jest wyzszy niz istniejacych, zeby animacja wejscia byla sekwencyjna.
  </action>
  <verify>
grep "fullTankComposition" SprayCalculator/ContentView.swift  # Znalezione w resultsSection
grep "partialTankComposition" SprayCalculator/ContentView.swift  # Znalezione
grep "totalChemicalToBuy" SprayCalculator/ContentView.swift  # Znalezione
grep "fullTankComposition" SprayCalculator/LocalizationManager.swift  # Klucz istnieje
grep "partialTankComposition" SprayCalculator/LocalizationManager.swift  # Klucz istnieje
grep "water:" SprayCalculator/LocalizationManager.swift  # Klucz istnieje
grep "totalChemicalToBuy" SprayCalculator/LocalizationManager.swift  # Klucz istnieje
  </verify>
  <done>3 nowe ResultCards w wynikach: sklad pelnego zbiornika (woda+srodek), sklad niepelnego zbiornika (warunkowy), srodek do kupienia. 4 nowe klucze lokalizacji w LocalizationManager. CALC-01, CALC-02, CALC-03 dostarczone.</done>
</task>

</tasks>

<verification>
1. CALC-01: resultsSection wyswietla waterPerFullTank + chemicalPerTank (sklad pelnego zbiornika)
2. CALC-02: resultsSection wyswietla waterForPartialTank + chemicalForPartialTank (sklad niepelnego) -- tylko gdy hasPartialTank
3. CALC-03: resultsSection wyswietla totalChemical jako "Srodek do kupienia"
4. UI-04: Logika obliczen, walidacji, formatowania jest w CalcViewModel -- widok nie ma zadnej logiki biznesowej
5. Istniejace funkcje: historia dodaje obliczenia, animacja traktora dziala, walidacja trzesie pustymi polami, ulubione laduja wartosci
6. Build: `xcodebuild -project SprayCalculator.xcodeproj -scheme SprayCalculator build` (jesli dostepne)
</verification>

<success_criteria>
- CalculatorViewWithFavorite nie zawiera logiki obliczen -- tylko binding do CalcViewModel
- Wyniki pokazuja 3 nowe karty: sklad pelnego zbiornika, sklad niepelnego zbiornika, srodek do kupienia
- 4 nowe klucze lokalizacji w LocalizationManager (fullTankComposition, partialTankComposition, water, totalChemicalToBuy)
- Animacja traktora, ulubione, walidacja dzialaja poprawnie
- Projekt buduje sie bez bledow
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-mvvm/01-03-SUMMARY.md`
</output>

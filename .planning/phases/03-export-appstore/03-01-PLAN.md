---
phase: 03-export-appstore
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - SprayCalculator/Services/PDFExportService.swift
  - SprayCalculator/Views/PDFContentView.swift
  - SprayCalculator/LocalizationManager.swift
  - SprayCalculator/ContentView.swift
autonomous: true

must_haves:
  truths:
    - "User can tap an export button after calculating and receive a shareable PDF"
    - "PDF contains input parameters, results, per-tank breakdown, date, and author signature"
    - "PDF is readable in both light mode and dark mode (hardcoded black/white colors)"
    - "Export button label shows in Polish and English depending on language setting"
  artifacts:
    - path: "SprayCalculator/Services/PDFExportService.swift"
      provides: "ImageRenderer-based PDF generation from SprayCalculation"
      contains: "ImageRenderer"
    - path: "SprayCalculator/Views/PDFContentView.swift"
      provides: "A4-width print-only SwiftUI layout for PDF rendering"
      contains: "PDFContentView"
    - path: "SprayCalculator/LocalizationManager.swift"
      provides: "All 6 new PL/EN localization strings for PDF export and About view"
      contains: "exportPDF"
    - path: "SprayCalculator/ContentView.swift"
      provides: "ShareLink export button in results section"
      contains: "ShareLink"
  key_links:
    - from: "SprayCalculator/ContentView.swift"
      to: "SprayCalculator/Services/PDFExportService.swift"
      via: "ShareLink(item: PDFExportService.generatePDF(...))"
      pattern: "PDFExportService\\.generatePDF"
    - from: "SprayCalculator/Services/PDFExportService.swift"
      to: "SprayCalculator/Views/PDFContentView.swift"
      via: "ImageRenderer(content: PDFContentView(...))"
      pattern: "PDFContentView"
    - from: "SprayCalculator/Views/PDFContentView.swift"
      to: "SprayCalculator/Models.swift"
      via: "Reads SprayCalculation properties for layout"
      pattern: "calculation\\."
---

<objective>
Create the PDF export feature: a PDFExportService that renders SprayCalculation data to a professional A4 PDF via ImageRenderer, a PDFContentView for the print layout, and a ShareLink button in the results section of ContentView. Also add all 6 new localization strings needed for Phase 3 (export + about view).

Purpose: Delivers requirement EXP-01 -- users can export calculation results as a shareable PDF document with inputs, results, per-tank breakdown, date, and author signature.
Output: PDFExportService.swift, PDFContentView.swift, updated LocalizationManager.swift, updated ContentView.swift with ShareLink.
</objective>

<execution_context>
@/Users/wojciecholszak/.claude/get-shit-done/workflows/execute-plan.md
@/Users/wojciecholszak/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-export-appstore/03-RESEARCH.md

@SprayCalculator/Models.swift
@SprayCalculator/LocalizationManager.swift
@SprayCalculator/ViewModels/CalcViewModel.swift
@SprayCalculator/ContentView.swift
@SprayCalculator/Services/SprayCalculatorService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PDFExportService, PDFContentView, and add localization strings</name>
  <files>
    SprayCalculator/Services/PDFExportService.swift
    SprayCalculator/Views/PDFContentView.swift
    SprayCalculator/LocalizationManager.swift
  </files>
  <action>
1. Create `SprayCalculator/Views/` directory (it does not exist yet -- views are currently in the root SprayCalculator/ folder, but new files go into Views/ per the RESEARCH architecture).

2. Create `SprayCalculator/Services/PDFExportService.swift`:
   - `struct PDFExportService` with a `@MainActor static func generatePDF(for calculation: SprayCalculation, localization: LocalizationManager) -> URL`
   - Create `PDFContentView` instance, wrap in `.frame(width: 595)` (A4 width in points)
   - Use `ImageRenderer(content:)` with `renderer.scale = 2.0`
   - Use `renderer.render { size, context in ... }` to create CGContext PDF at `URL.documentsDirectory.appending(path: "KalkulatorOprysku.pdf")`
   - Call `pdf.beginPDFPage(nil)`, `context(pdf)`, `pdf.endPDFPage()`, `pdf.closePDF()`
   - Return the URL
   - See 03-RESEARCH.md "Pattern 1: PDFExportService" for exact code pattern

3. Create `SprayCalculator/Views/PDFContentView.swift`:
   - `struct PDFContentView: View` accepting `let calculation: SprayCalculation` and `let localization: LocalizationManager`
   - CRITICAL: Use ONLY `Color.black` and `Color.white` for text and background. NEVER use Asset Catalog colors like `Color(.textPrimary)` -- these resolve to light colors in dark mode and produce unreadable PDFs.
   - Layout in VStack(alignment: .leading, spacing: 20) with .padding(40):
     a. Header: App title (localization.appTitle) in .title.bold()
     b. Divider
     c. Date: `calculation.date.formatted(date: .long, time: .shortened)` in .subheadline, .secondary color
     d. "Parametry" / "Parameters" section header in .headline
     e. Grid with input parameters: fieldArea + unit, sprayRate, chemicalRate, tankCapacity (use localization labels, bold values)
     f. Divider
     g. "Wyniki" / "Results" section header in .headline
     h. Grid with results: totalWorkingFluid, totalChemical, tankFills description
     i. Divider
     j. Full tank composition: water + chemical amounts
     k. If hasPartialTank: partial tank composition
     l. Spacer
     m. Divider
     n. Footer signature: localization.pdfSignature in .caption, .secondary color
   - Include private `formatNumber(_ value: Double) -> String` helper using NumberFormatter with comma decimal separator and space grouping (same pattern as CalcViewModel.formatNumber)
   - Include private `tankDescription` computed property (same logic as CalcViewModel.tankFillsDescription)
   - Apply `.foregroundStyle(Color.black)` and `.background(Color.white)` on the outer VStack
   - See 03-RESEARCH.md "PDF Content Layout View" for exact code pattern

4. Add 6 new localization strings to `LocalizationManager.swift` in a new `// MARK: - Export & About (EXP-01, EXP-02)` section after the existing per-tank composition section:
   - `exportPDF`: "Eksportuj PDF" / "Export PDF"
   - `about`: "O aplikacji" / "About"
   - `author`: "Autor" / "Author"
   - `contact`: "Kontakt" / "Contact"
   - `pdfSignature`: "Wygenerowano w aplikacji autorstwa Wojciecha Olszaka" / "Generated in app by Wojciech Olszak"
   - `parameters`: "Parametry" / "Parameters"

5. Add both new files to the Xcode project (project.pbxproj) so they compile. Use the existing file reference pattern -- find the PBXGroup for Services and add PDFExportService.swift, create a new PBXGroup for Views and add PDFContentView.swift. If editing pbxproj is too complex, note this for Task 2 verification.
  </action>
  <verify>
    - `grep -r "ImageRenderer" SprayCalculator/Services/PDFExportService.swift` returns matches
    - `grep -r "Color.black" SprayCalculator/Views/PDFContentView.swift` returns matches (confirms no Asset Catalog colors in PDF)
    - `grep -r "Color(.textPrimary)" SprayCalculator/Views/PDFContentView.swift` returns NO matches (critical: no dark-mode-adaptive colors)
    - `grep "exportPDF\|pdfSignature\|parameters" SprayCalculator/LocalizationManager.swift` returns 3+ matches
    - Project builds: `xcodebuild -project SprayCalculator.xcodeproj -scheme SprayCalculator -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`
  </verify>
  <done>
    PDFExportService.swift exists with generatePDF() that uses ImageRenderer + CGContext to render A4 PDF. PDFContentView.swift exists with full calculation layout using hardcoded black/white colors. LocalizationManager has all 6 new PL/EN strings. Project compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ShareLink export button to ContentView results section</name>
  <files>
    SprayCalculator/ContentView.swift
  </files>
  <action>
1. In `ContentView.swift`, in the `resultsSection(result:)` function of `CalculatorViewWithFavorite`, add a ShareLink AFTER the last ResultCard (the CALC-03 "total chemical to buy" card):

```swift
// EXP-01: Export PDF button
ShareLink(
    item: PDFExportService.generatePDF(for: result, localization: localization),
    preview: SharePreview(
        localization.appTitle,
        image: Image(systemName: "doc.text")
    )
) {
    Label(localization.exportPDF, systemImage: "square.and.arrow.up")
        .font(.body.weight(.semibold))
        .fontDesign(.rounded)
        .foregroundStyle(.white)
        .frame(maxWidth: .infinity)
        .padding(.vertical, 14)
        .background(
            RoundedRectangle(cornerRadius: 16)
                .fill(Color(.primaryGreen))
        )
}
.padding(.top, 8)
```

2. The ShareLink(item:) approach works because URL conforms to Transferable. For this simple single-page PDF, eager evaluation is acceptable (generation is nearly instant). Per RESEARCH.md Pitfall 6, this is "Option A" which is sufficient for this app.

3. Make sure `import SwiftUI` is already at top (it is). No additional imports needed since PDFExportService is in the same target.
  </action>
  <verify>
    - `grep "ShareLink" SprayCalculator/ContentView.swift` returns a match
    - `grep "PDFExportService" SprayCalculator/ContentView.swift` returns a match
    - `grep "exportPDF" SprayCalculator/ContentView.swift` returns a match
    - Project builds: `xcodebuild -project SprayCalculator.xcodeproj -scheme SprayCalculator -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`
  </verify>
  <done>
    ContentView shows a green "Eksportuj PDF" / "Export PDF" button after calculation results. Tapping it generates a PDF via PDFExportService and presents the native iOS share sheet with the PDF file. EXP-01 is complete.
  </done>
</task>

</tasks>

<verification>
- `xcodebuild -project SprayCalculator.xcodeproj -scheme SprayCalculator -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20` -- zero errors
- `grep -rn "Color(.textPrimary)\|Color(.backgroundCard)" SprayCalculator/Views/PDFContentView.swift` -- must return NO matches (PDF safety check)
- `grep -c "exportPDF\|about\|author\|contact\|pdfSignature\|parameters" SprayCalculator/LocalizationManager.swift` -- returns 6+ (all strings present)
- `grep "ShareLink" SprayCalculator/ContentView.swift` -- returns match
</verification>

<success_criteria>
1. PDFExportService.swift generates a valid PDF file using ImageRenderer with A4 width (595pt)
2. PDFContentView.swift renders calculation data with hardcoded black text on white background (dark-mode safe)
3. PDF contains: app title, date, input parameters, results, per-tank breakdown, author signature
4. ShareLink button appears in results section after calculation
5. All 6 new localization strings work in both Polish and English
6. Project compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-export-appstore/03-01-SUMMARY.md`
</output>
